{{ define "main" }}
<main class="music-page">
  <article>
    <div class="title">
      <h1 class="title">{{ .Title }}</h1>
      {{ with .Description }}<div class="meta">{{ . }}</div>{{ end }}
    </div>
    <section class="body">
      {{/* We'll parse the raw content to build grouped video sections. */}}
      {{ $raw := .RawContent }}
      {{ $lines := split $raw "\n" }}
      {{ $currentHeading := "" }}
      {{ $videos := slice }}
      {{ range $i, $l := $lines }}
        {{ $trim := trim $l " " }}
        {{ if hasPrefix $trim "## " }}
          {{/* If we have accumulated videos for previous heading, render them */}}
          {{ if and (ne $currentHeading "") (gt (len $videos) 0) }}
            <h2 id="{{ anchorize $currentHeading }}">{{ $currentHeading }}</h2>
            <div class="video-collage">
              {{ range $videos }}
                <div class="video-item">
                  <div class="video-wrapper">
                    <iframe src="https://www.youtube.com/embed/{{ . }}" title="YouTube video" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen loading="lazy"></iframe>
                  </div>
                </div>
              {{ end }}
            </div>
          {{ end }}
          {{/* Reset for new heading */}}
          {{ $currentHeading = (replace $trim "## " "") }}
          {{ $videos = slice }}
        {{ else if hasPrefix $trim "youtube:" }}
          {{ $id := replace $trim "youtube:" "" }}
          {{ $videos = $videos | append $id }}
        {{ end }}
      {{ end }}
      {{/* Render last group */}}
      {{ if and (ne $currentHeading "") (gt (len $videos) 0) }}
        <h2 id="{{ anchorize $currentHeading }}">{{ $currentHeading }}</h2>
        <div class="video-collage">
          {{ range $videos }}
            <div class="video-item">
              <div class="video-wrapper">
                <iframe src="https://www.youtube.com/embed/{{ . }}" title="YouTube video" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen loading="lazy"></iframe>
              </div>
            </div>
          {{ end }}
        </div>
      {{ end }}
      <noscript>Please enable JavaScript to view the video collage.</noscript>
    </section>
  </article>
</main>
{{ end }}
